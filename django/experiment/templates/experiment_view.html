{% extends 'base.html'  %}
{% load static %}

{% block scripts_extra %}
{% endblock %}

{% block body %}
<div class="columns">
  <div class="column is-one-fifth">
    <section class="section">
      <h1 class="title">
        Experiments
      </h1>
      <div id="experiments-component"></div>
    </section>
  </div>
  <div class="column is-two-fifths" id="second-column">
  </div>
  <div class="column is-two-fifths">
  </div>

</div>
<!-- <script type="importmap">
     {
     "imports": {
     "preact": "https://esm.sh/preact@10.12.1",
     "preact/hooks": "https://esm.sh/preact@10.12.1/hooks?external=preact",
     "@preact/signals": "https://esm.sh/@preact/signals@1.1.3?external=preact",
     "htm": "https://esm.sh/htm@3.1.1",
     "cytoscape": "{% static 'js/external/cytoscape.esm.min.js' %}",
     "cytoscape-cola": "{% static 'js/external/cytoscape-cola.mjs' %}",
     "cytoscape_utils": "{% static 'js/external/cytoscape_utils.mjs' %}",
     "cytoscape_pnet": "{% static 'js/external/cytoscape_pnet.js' %}",
     "utils": "{% static 'js/utils.mjs' %}"
     }
     }
     </script> -->

<script type="importmap">
 {
   "imports": {
     "preact": "https://esm.sh/preact@10.12.1",
     "preact/hooks": "https://esm.sh/preact@10.12.1/hooks?external=preact",
     "@preact/signals": "https://esm.sh/@preact/signals@1.1.3?external=preact",
     "htm": "{% static 'js/external/htm_3.1.1.mjs' %}",
     "cytoscape": "{% static 'js/external/cytoscape.esm.min.js' %}",
     "cytoscape-cola": "{% static 'js/external/cytoscape-cola.mjs' %}",
     "cytoscape_utils": "{% static 'js/external/cytoscape_utils.mjs' %}",
     "cytoscape_pnet": "{% static 'js/external/cytoscape_pnet.js' %}",
     "utils": "{% static 'js/utils.mjs' %}"
   }
 }
</script>
<script type="module">
 import { h, render } from "preact";
 import { signal, effect } from "@preact/signals";
 import { useState, useRef, useEffect } from 'preact/hooks';
 import htm from "htm";
 import {setup_pnet_cy} from 'cytoscape_utils';
 import {pnet_to_cytoscape_elements} from 'cytoscape_pnet';
 import {urlSyncedSignal} from 'utils';

 const html = htm.bind(h);
 const exp_id = urlSyncedSignal("exp_id", null);
 const snapshot = signal(null);
 const experiment = signal(null);

 // called when mol.value changes
 effect( () => {
   console.log("CHANGE", exp_id.value)
   if (exp_id.value === null) {return}
   fetch(`http://${window.location.host}/experiment/${exp_id}`, {
     method: 'GET',
     headers: {
       'Accept': 'application/json',
       'Content-Type': 'application/json'
     },
   }).then(
     response => response.json()
   ).then(
     data => {
       console.log("RECEIVED", data)
       const {last_snapshot, ...experiment_data} = data;

       snapshot.value = last_snapshot;
       experiment.value = experiment_data;
       console.log("EXP", experiment.value)
     }
   )
 })

 let SnapshotInfoPanel = () => {
   if (!snapshot.value) {return null}

   return html`
     <div class="message">
       <div class="message-body content">
         Loaded snapshot:
         <ul>
           <li>${snapshot.value.timestamp}</li>
           <li>${snapshot.value.nb_reactions} reactions performed</li>
         </ul>
       </div>
     </div>`
 }

 let ExperimentInfoPanel = () => {
   if (!experiment.value) {return null}

   return html`
     <div class="message">
       <div class="message-header">${experiment.value.name}</div>
       <div class="message-body content">
         ${experiment.value.description}
       </div>
     </div>`
 }


 let ExperimentSection = () => {

   const selected = exp_id.value
   let onChange = e => {
     exp_id.value = e.target.value
   }
   return html`
     <Fragment>
       <div class="select">
         <select value=${selected} onChange=${onChange}>
           {% for experiment in experiments %}
           <option value="{{experiment.id}}">{{experiment.id}} - {{experiment.name}}</option>
           {% endfor %}
         </select>
       </div>
       <${ExperimentInfoPanel} />
       <${SnapshotInfoPanel} />
     </Fragment>
   `
 }
 let MolDisplay = ({mol}) => {
   return html`<div style="overflow: hidden; text-overflow: ellipsis; max-width: 100%">${mol}</div>`
 }

 let ImolDisplay = ({mol, qtt, ambient}) => {
   const ambient_str = ambient ? " (ambient)" : ""

   return html`<tr><td>${mol}</td><td>${qtt}</td></tr>`
 }

 let ImolListDisplay = ({imols}) => {
   return html`
     <table class="table is-striped is-fullwidth" style="table-layout: fixed">
       <thead><tr><th>Molecule</th><th style="width: 10%">Qtt</th></tr></thead>
       <tbody>
         ${imols.map(imol => ImolDisplay(imol))}
       </tbody>
     </table>`
 }

 let AmolDisplay = ({mol, pnets}) => {
   const [open, setOpen] = useState(false);
   const qtt = pnets.length

   if (!open) {
     return html`<tr><td>${MolDisplay({mol})}</td><td>${qtt}</td></tr>`
   } else {
   }
 }


 let AmolListDisplay = ({amols}) => {
   return html`
     <table class="table is-striped is-fullwidth" style="table-layout: fixed">
       <thead><tr><th>Molecule</th><th style="width: 10%">Qtt</th></tr></thead>
       <tbody>
         ${amols.map(([mol, pnets]) => AmolDisplay({mol, pnets}))}
       </tbody>
     </table>`
 }

 let MoleculesDisplay = () => {
   if (!snapshot.value) {return null}

   const imols_all = snapshot.value.data.ireactants
   const ambient_imols = []
   const imols = []
   for (let imol of imols_all) {
     if (imol.ambient) {ambient_imols.push(imol)} else {imols.push(imol)}
   }
   const amols = snapshot.value.data.areactants


   return html`
     <section class="section">
       <h1 class="title">
         Ambient molecules
       </h1>
       <${ImolListDisplay} imols=${ambient_imols} } />
     </section>
     <section class="section">
       <h1 class="title">
         Inert molecules
       </h1>
       <${ImolListDisplay} imols=${imols} />
     </section>
     <section class="section">
       <h1 class="title">
         Active molecules
       </h1>
       <${AmolListDisplay} amols=${amols} />
     </section>
   `

 }



 render(html`<${ExperimentSection} />`, document.getElementById("experiments-component"));
 /* render(html`<${ImolListDisplay} />`, document.getElementById("inert-mols-component"));
  * render(html`<${AmolListDisplay} />`, document.getElementById("active-mols-component")); */
 render(html`<${MoleculesDisplay} />`, document.getElementById("second-column"));
</script>
{% endblock %}
